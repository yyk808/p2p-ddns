# p2p-ddns Integration Test Environment
# This composition creates a multi-subnet network environment for testing

networks:
  subnet-a:
    external: true
    name: subnet-a

  subnet-b:
    external: true
    name: subnet-b

  public:
    external: true
    name: public

volumes:
  primary-data:
    driver: local
  daemon-a1-data:
    driver: local
  daemon-a2-data:
    driver: local
  daemon-b1-data:
    driver: local
  daemon-b2-data:
    driver: local
  shared-tickets:
    driver: local
  logs:
    driver: local

services:
  # Primary Node - Network Creator
  primary-node:
    image: p2p-ddns-test-primary:test
    container_name: p2p-ddns-test-primary
    hostname: primary-node
    privileged: true
    networks:
      subnet-a:
        ipv4_address: 10.0.1.10
      subnet-b:
        ipv4_address: 10.0.2.10
      public:
        ipv4_address: 10.0.0.10
    volumes:
      - primary-data:/app/data
      - shared-tickets:/shared
      - logs:/app/logs
    environment:
      - NODE_NAME=primary-node
      - P2P_DDNS_MODE=daemon
      - P2P_DDNS_PRIMARY=true
      - P2P_DDNS_DOMAIN=primary-node
      - P2P_DDNS_LOG_LEVEL=debug
      - P2P_DDNS_BIND_ADDRESS=0.0.0.0:8080
      - XDG_RUNTIME_DIR=/tmp
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "/app/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    depends_on: []

  # Daemon Nodes - Subnet A
  daemon-a1:
    image: p2p-ddns-test-daemon:test
    container_name: p2p-ddns-test-daemon-a1
    hostname: daemon-a1
    networks:
      subnet-a:
        ipv4_address: 10.0.1.11
    volumes:
      - daemon-a1-data:/app/data
      - shared-tickets:/shared
      - logs:/app/logs
    environment:
      - NODE_NAME=daemon-a1
      - P2P_DDNS_MODE=daemon
      - P2P_DDNS_DOMAIN=daemon-a1
      - P2P_DDNS_LOG_LEVEL=info
      - P2P_DDNS_BIND_ADDRESS=0.0.0.0:8081
      - TICKET_FILE=/shared/ticket.txt
      - PRIMARY_HOST=primary-node
      - TICKET_WAIT_TIMEOUT=120
      - XDG_RUNTIME_DIR=/tmp
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "/app/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    depends_on:
      primary-node:
        condition: service_healthy

  daemon-a2:
    image: p2p-ddns-test-daemon:test
    container_name: p2p-ddns-test-daemon-a2
    hostname: daemon-a2
    networks:
      subnet-a:
        ipv4_address: 10.0.1.12
    volumes:
      - daemon-a2-data:/app/data
      - shared-tickets:/shared
      - logs:/app/logs
    environment:
      - NODE_NAME=daemon-a2
      - P2P_DDNS_MODE=daemon
      - P2P_DDNS_DOMAIN=daemon-a2
      - P2P_DDNS_LOG_LEVEL=info
      - P2P_DDNS_BIND_ADDRESS=0.0.0.0:8082
      - TICKET_FILE=/shared/ticket.txt
      - PRIMARY_HOST=primary-node
      - TICKET_WAIT_TIMEOUT=120
      - XDG_RUNTIME_DIR=/tmp
    ports:
      - "8082:8080"
    healthcheck:
      test: ["CMD", "/app/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    depends_on:
      primary-node:
        condition: service_healthy

  # Daemon Nodes - Subnet B
  daemon-b1:
    image: p2p-ddns-test-daemon:test
    container_name: p2p-ddns-test-daemon-b1
    hostname: daemon-b1
    networks:
      subnet-b:
        ipv4_address: 10.0.2.11
      public:
        ipv4_address: 10.0.0.11
    volumes:
      - daemon-b1-data:/app/data
      - shared-tickets:/shared
      - logs:/app/logs
    environment:
      - NODE_NAME=daemon-b1
      - P2P_DDNS_MODE=daemon
      - P2P_DDNS_DOMAIN=daemon-b1
      - P2P_DDNS_LOG_LEVEL=info
      - P2P_DDNS_BIND_ADDRESS=0.0.0.0:8083
      - TICKET_FILE=/shared/ticket.txt
      - PRIMARY_HOST=primary-node
      - TICKET_WAIT_TIMEOUT=120
      - XDG_RUNTIME_DIR=/tmp
    ports:
      - "8083:8080"
    healthcheck:
      test: ["CMD", "/app/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    depends_on:
      primary-node:
        condition: service_healthy

  daemon-b2:
    image: p2p-ddns-test-daemon:test
    container_name: p2p-ddns-test-daemon-b2
    hostname: daemon-b2
    networks:
      subnet-b:
        ipv4_address: 10.0.2.12
    volumes:
      - daemon-b2-data:/app/data
      - shared-tickets:/shared
      - logs:/app/logs
    environment:
      - NODE_NAME=daemon-b2
      - P2P_DDNS_MODE=daemon
      - P2P_DDNS_DOMAIN=daemon-b2
      - P2P_DDNS_LOG_LEVEL=info
      - P2P_DDNS_BIND_ADDRESS=0.0.0.0:8084
      - TICKET_FILE=/shared/ticket.txt
      - PRIMARY_HOST=primary-node
      - TICKET_WAIT_TIMEOUT=120
      - XDG_RUNTIME_DIR=/tmp
    ports:
      - "8084:8080"
    healthcheck:
      test: ["CMD", "/app/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    depends_on:
      primary-node:
        condition: service_healthy

  # Monitor Node - For testing and observation
  monitor:
    image: alpine:latest
    container_name: p2p-ddns-test-monitor
    hostname: monitor
    networks:
      public:
        ipv4_address: 10.0.0.20
    volumes:
      - shared-tickets:/shared:ro
      - logs:/logs:ro
      - ./scripts:/scripts:ro
    command: >
      sh -c "
        apk add --no-cache iputils-ping net-tools curl jq &&
        while true; do
          echo '=== Monitor Status ==='
          date
          echo 'Network connectivity:'
          ping -c 1 primary-node >/dev/null 2>&1 && echo '  primary-node: OK' || echo '  primary-node: FAIL'
          ping -c 1 daemon-a1 >/dev/null 2>&1 && echo '  daemon-a1: OK' || echo '  daemon-a1: FAIL'
          ping -c 1 daemon-b1 >/dev/null 2>&1 && echo '  daemon-b1: OK' || echo '  daemon-b1: FAIL'
          echo 'Recent logs:'
          tail -n 5 /logs/primary.log 2>/dev/null | grep -E '(ERROR|INFO|WARN)' | tail -n 3 || echo '  No recent logs'
          echo '========================'
          echo
          sleep 30
        done
      "
    restart: unless-stopped
    depends_on:
      primary-node:
        condition: service_healthy
